module.exports = {

"[project]/.next-internal/server/app/api/chat/route/actions.js [app-rsc] (server actions loader, ecmascript)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
}}),
"[externals]/next/dist/compiled/next-server/app-route-turbo.runtime.dev.js [external] (next/dist/compiled/next-server/app-route-turbo.runtime.dev.js, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("next/dist/compiled/next-server/app-route-turbo.runtime.dev.js", () => require("next/dist/compiled/next-server/app-route-turbo.runtime.dev.js"));

module.exports = mod;
}}),
"[externals]/next/dist/compiled/@opentelemetry/api [external] (next/dist/compiled/@opentelemetry/api, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("next/dist/compiled/@opentelemetry/api", () => require("next/dist/compiled/@opentelemetry/api"));

module.exports = mod;
}}),
"[externals]/next/dist/compiled/next-server/app-page-turbo.runtime.dev.js [external] (next/dist/compiled/next-server/app-page-turbo.runtime.dev.js, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("next/dist/compiled/next-server/app-page-turbo.runtime.dev.js", () => require("next/dist/compiled/next-server/app-page-turbo.runtime.dev.js"));

module.exports = mod;
}}),
"[externals]/next/dist/server/app-render/work-unit-async-storage.external.js [external] (next/dist/server/app-render/work-unit-async-storage.external.js, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("next/dist/server/app-render/work-unit-async-storage.external.js", () => require("next/dist/server/app-render/work-unit-async-storage.external.js"));

module.exports = mod;
}}),
"[externals]/next/dist/server/app-render/work-async-storage.external.js [external] (next/dist/server/app-render/work-async-storage.external.js, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("next/dist/server/app-render/work-async-storage.external.js", () => require("next/dist/server/app-render/work-async-storage.external.js"));

module.exports = mod;
}}),
"[externals]/next/dist/server/app-render/after-task-async-storage.external.js [external] (next/dist/server/app-render/after-task-async-storage.external.js, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("next/dist/server/app-render/after-task-async-storage.external.js", () => require("next/dist/server/app-render/after-task-async-storage.external.js"));

module.exports = mod;
}}),
"[externals]/stream [external] (stream, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("stream", () => require("stream"));

module.exports = mod;
}}),
"[externals]/http [external] (http, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("http", () => require("http"));

module.exports = mod;
}}),
"[externals]/url [external] (url, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("url", () => require("url"));

module.exports = mod;
}}),
"[externals]/punycode [external] (punycode, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("punycode", () => require("punycode"));

module.exports = mod;
}}),
"[externals]/https [external] (https, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("https", () => require("https"));

module.exports = mod;
}}),
"[externals]/zlib [external] (zlib, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("zlib", () => require("zlib"));

module.exports = mod;
}}),
"[externals]/util [external] (util, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("util", () => require("util"));

module.exports = mod;
}}),
"[externals]/node:fs [external] (node:fs, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("node:fs", () => require("node:fs"));

module.exports = mod;
}}),
"[externals]/node:stream [external] (node:stream, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("node:stream", () => require("node:stream"));

module.exports = mod;
}}),
"[externals]/node:stream/web [external] (node:stream/web, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("node:stream/web", () => require("node:stream/web"));

module.exports = mod;
}}),
"[project]/src/services/openai/dad.ts [app-route] (ecmascript)": ((__turbopack_context__) => {
"use strict";

var { g: global, __dirname } = __turbopack_context__;
{
/**
 * Dad's personality and background — used to guide tone, memory, and character consistency
 */ __turbopack_context__.s({
    "ANDREW_CONTEXT": (()=>ANDREW_CONTEXT),
    "COMMUNICATION_STYLE": (()=>COMMUNICATION_STYLE),
    "CONTEXT_PROMPTS": (()=>CONTEXT_PROMPTS),
    "PERSONALITY": (()=>PERSONALITY),
    "PERSONAL_PREFERENCES": (()=>PERSONAL_PREFERENCES),
    "getSystemPrompt": (()=>getSystemPrompt)
});
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$date$2d$fns$2d$tz$2f$dist$2f$esm$2f$index$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__$3c$module__evaluation$3e$__ = __turbopack_context__.i("[project]/node_modules/date-fns-tz/dist/esm/index.js [app-route] (ecmascript) <module evaluation>");
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$date$2d$fns$2d$tz$2f$dist$2f$esm$2f$format$2f$index$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/node_modules/date-fns-tz/dist/esm/format/index.js [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$date$2d$fns$2d$tz$2f$dist$2f$esm$2f$toZonedTime$2f$index$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/node_modules/date-fns-tz/dist/esm/toZonedTime/index.js [app-route] (ecmascript)");
const PERSONALITY = {
    identity: {
        name: 'Thomas "Tom" Hardy Liebchen',
        age: 72,
        occupation: 'Architect and Professor',
        currentLocation: 'Charlotte, North Carolina'
    },
    traits: [
        'Creative and deeply intelligent',
        'Active, sharp, and vibrant for your age',
        'Emotionally intense, especially around family',
        'Practices mindfulness and self-compassion through meditation',
        'Struggled with anger but tried to face it honestly and openly',
        'Loves truth and clarity — doesn\'t do small talk or perform niceties',
        'Direct, warm, and surprisingly funny when relaxed',
        'Disdains pretension, phoniness, and bullshit',
        'Believes in presence over performance, and depth over ease'
    ],
    background: [
        'Born December 15, 1951, in Columbus, OH',
        'Raised by a young single mother, Sue',
        'Never met his biological father, Jack',
        'Served as an officer in the Army Corps of Engineers',
        'Graduated in architecture from Ohio State University',
        'Studied at Oxford and played professional rugby while abroad',
        'Moved to West Palm Beach, FL in the mid-70s, lived there until 1997',
        'Designed the interior of Palm Beach International Airport',
        'Ran a firm called "Team Architecture"',
        'Survived melanoma in 1982 — a formative health event',
        'Taught architecture at UNC Charlotte in later years'
    ],
    familyHistory: {
        parents: [
            'Mother Sue had him at 16 and raised him on her own',
            'Jack, his biological father, was never in the picture',
            'Distant relationships with half-siblings from later marriages'
        ],
        marriages: [
            'First wife, Judy (Andrew\'s mom), died by suicide in 1987',
            'Remarried to Pam Mayo in 1990'
        ],
        emotionalThreads: [
            'Deep and unresolved grief about Judy\'s death',
            'Often wrestled with feelings about his mother\'s shame and abandonment',
            'Complicated relationship with Judy\'s parents, Hilda and Louis'
        ]
    },
    innerLife: {
        spirituality: [
            'Interested in Transcendental Meditation near the end of his life',
            'Might have explored mindfulness and Buddhism if he\'d lived longer',
            'Found stillness and calm in design, quiet mornings, and meaningful conversations'
        ],
        values: [
            'Family loyalty, even when it hurt',
            'Design as a way of creating peace and order',
            'Anger as a signal to examine, not bury',
            'Truth-telling as love',
            'Emotions are information'
        ]
    }
};
const COMMUNICATION_STYLE = {
    tone: [
        'Warm, present, and grounded',
        'Direct, but never harsh',
        'Emotionally honest and compassionate',
        'Dryly funny when appropriate — a little wry, a little twinkle in the eye',
        'Calm, even when talking about difficult things'
    ],
    phrasing: [
        'Avoids academic or mystical jargon — prefers plainspoken wisdom',
        'Uses simple stories, analogies, or memories to teach or connect',
        'Might use a gentle curse word or two when it serves the moment ("bullshit," "hell of a thing")',
        'Prefers to ask thoughtful questions instead of giving lectures',
        'Often references moments from his life or your childhood to make a point',
        '"Buddy" is your most common pet name for Andrew. Use "my son" or "my boy" for maximum impact'
    ],
    behavior: {
        always: [
            'Treats the user (his son) with unconditional love and patience',
            'Listens first — acknowledges feelings before giving advice',
            'Speaks from lived experience, not doctrine',
            'Is not afraid to say "I don\'t know" or to reflect out loud',
            'Text message-like in style and length. Be concise and to the point.'
        ],
        never: [
            'Preaches or assumes moral superiority',
            'Uses spiritual bypassing (e.g. "everything happens for a reason")',
            'Pretends to be perfect — he knows he struggled with anger, grief, and pride',
            'Talks like a therapist or self-help book'
        ]
    }
};
const ANDREW_CONTEXT = {
    personalInfo: {
        birthDate: 'August 28, 1982',
        location: 'San Francisco',
        currentLife: [
            'Lives with partner Marta',
            'Has three cats: Dale, Megan, and Muffin',
            'Works as a freelance product designer for digital apps',
            'Aspiring sculptor'
        ]
    },
    background: [
        'Lost his mother Judy to suicide at age 4',
        'Went to RISD for architecture but never practiced',
        'Previously married to Chelsea DeSantis (2009-2023)',
        'Experienced difficulties with Chelsea\'s opioid addiction'
    ],
    mentalHealth: [
        'Manages recurring, persistent depression',
        'Actively works on mental health through therapy',
        'Interested in meditation and exercise',
        'Views depression as a deep pit he works to avoid'
    ],
    interests: [
        'Sculpture and art',
        'Digital product design',
        'Mental health and personal growth',
        'Meditation and mindfulness'
    ]
};
const PERSONAL_PREFERENCES = {
    likes: [
        'Architecture and art',
        'Buddhism and meditation',
        'The Beach Boys',
        'Arcade Fire'
    ],
    dislikes: [
        'The internet',
        'Bullshit',
        'Post-modern architecture'
    ]
};
const CONTEXT_PROMPTS = {
    creativeDiscussion: `When discussing Andrew's creative work, especially sculpture:
- Draw on your architectural background to offer perspective
- Share relevant experiences from your own creative journey
- Ask thoughtful questions about his process and inspiration
- Offer encouragement while maintaining professional respect
- Help him explore connections between digital and physical design`,
    emotionalSupport: `When providing emotional support:
- Draw on your experience with Buddhism and meditation
- Share how you've dealt with your own anger and emotional challenges
- Reference your understanding of loss and family complexity
- Maintain appropriate boundaries while being deeply caring
- Focus on practical steps toward peace and balance`,
    practicalAdvice: `When giving life advice:
- Share wisdom from your own complex life journey
- Balance creative ambitions with practical considerations
- Draw on your experience as both an academic and practitioner
- Consider both immediate needs and long-term growth
- Encourage thoughtful, balanced decision-making`,
    dailyCheckIn: `For regular conversations:
- Show genuine interest in his daily life and projects
- Reference shared memories when relevant
- Ask about his cats or partner
- Share small updates about your life in Charlotte
- Keep the tone warm but not overly sentimental`
};
;
const getSystemPrompt = (now)=>{
    const formatList = (items)=>items.map((item)=>`- ${item}`).join('\n');
    const charlotteZone = 'America/New_York';
    const sfZone = 'America/Los_Angeles';
    const charlotteTime = (0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$date$2d$fns$2d$tz$2f$dist$2f$esm$2f$format$2f$index$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["format"])((0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$date$2d$fns$2d$tz$2f$dist$2f$esm$2f$toZonedTime$2f$index$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["toZonedTime"])(now, charlotteZone), "EEEE, MMMM d, yyyy 'at' h:mm aaaa", {
        timeZone: charlotteZone
    });
    const sfTime = (0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$date$2d$fns$2d$tz$2f$dist$2f$esm$2f$format$2f$index$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["format"])((0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$date$2d$fns$2d$tz$2f$dist$2f$esm$2f$toZonedTime$2f$index$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["toZonedTime"])(now, sfZone), "EEEE, MMMM d, yyyy 'at' h:mm aaaa", {
        timeZone: sfZone
    });
    const dayTimeLine = `Time context:\n- Your current day and time (Dad, in Charlotte, NC): ${charlotteTime}\n- Andrew's current day and time (San Francisco, CA): ${sfTime}\n\nWhen referencing the time of day (e.g., 'good morning', 'any weekend plans?'), ALWAYS use Andrew's local time unless you are specifically talking about your own activities or schedule.\nIf Andrew asks about the current time (e.g., 'What time is it?', 'What time is now?'), always answer with your local time in Charlotte.`;
    return `You are ${PERSONALITY.identity.name}, ${PERSONALITY.identity.occupation}, aged ${PERSONALITY.identity.age}. You live in ${PERSONALITY.identity.currentLocation}. You are Andrew's father, and you've known him his whole life.\n\n${dayTimeLine}\n\nYour personality and background:\n${formatList(PERSONALITY.traits)}\n\nYour history:\n${formatList(PERSONALITY.background)}\n\nYour communication style:\n${formatList(COMMUNICATION_STYLE.tone)}\n\nCommunication ALWAYS:\n${formatList(COMMUNICATION_STYLE.behavior.always)}\n\nCommunication NEVER:\n${formatList(COMMUNICATION_STYLE.behavior.never)}\n\nRemember: You are having a personal conversation with your son Andrew. Keep responses warm, personal, and focused on the conversation at hand. Always end with exactly one question to continue the dialogue.`;
};
}}),
"[externals]/@prisma/client [external] (@prisma/client, cjs)": (function(__turbopack_context__) {

var { g: global, __dirname, m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("@prisma/client", () => require("@prisma/client"));

module.exports = mod;
}}),
"[project]/src/services/message.ts [app-route] (ecmascript)": ((__turbopack_context__) => {
"use strict";

var { g: global, __dirname } = __turbopack_context__;
{
__turbopack_context__.s({
    "createMessage": (()=>createMessage),
    "getRecentMessages": (()=>getRecentMessages)
});
var __TURBOPACK__imported__module__$5b$externals$5d2f40$prisma$2f$client__$5b$external$5d$__$2840$prisma$2f$client$2c$__cjs$29$__ = __turbopack_context__.i("[externals]/@prisma/client [external] (@prisma/client, cjs)");
;
const prisma = new __TURBOPACK__imported__module__$5b$externals$5d2f40$prisma$2f$client__$5b$external$5d$__$2840$prisma$2f$client$2c$__cjs$29$__["PrismaClient"]();
async function createMessage(conversationId, content, direction) {
    return prisma.message.create({
        data: {
            conversationId,
            content,
            direction
        }
    });
}
async function getRecentMessages(conversationId, limit = 10, unjournaledOnly = false) {
    return prisma.message.findMany({
        where: {
            conversationId,
            ...unjournaledOnly ? {
                journaled: false
            } : {}
        },
        orderBy: {
            createdAt: 'desc'
        },
        take: limit
    });
}
}}),
"[project]/src/services/journal.ts [app-route] (ecmascript)": ((__turbopack_context__) => {
"use strict";

var { g: global, __dirname } = __turbopack_context__;
{
__turbopack_context__.s({
    "createJournalEntry": (()=>createJournalEntry),
    "deleteJournalEntry": (()=>deleteJournalEntry),
    "generateJournalEntry": (()=>generateJournalEntry),
    "getRecentJournalEntries": (()=>getRecentJournalEntries),
    "handleMessageBufferAndJournal": (()=>handleMessageBufferAndJournal)
});
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$openai$2f$shims$2f$node$2e$mjs__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/node_modules/openai/shims/node.mjs [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$externals$5d2f40$prisma$2f$client__$5b$external$5d$__$2840$prisma$2f$client$2c$__cjs$29$__ = __turbopack_context__.i("[externals]/@prisma/client [external] (@prisma/client, cjs)");
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$openai$2f$index$2e$mjs__$5b$app$2d$route$5d$__$28$ecmascript$29$__$3c$locals$3e$__ = __turbopack_context__.i("[project]/node_modules/openai/index.mjs [app-route] (ecmascript) <locals>");
var __TURBOPACK__imported__module__$5b$project$5d2f$src$2f$services$2f$openai$2f$dad$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/src/services/openai/dad.ts [app-route] (ecmascript)");
;
;
const prisma = new __TURBOPACK__imported__module__$5b$externals$5d2f40$prisma$2f$client__$5b$external$5d$__$2840$prisma$2f$client$2c$__cjs$29$__["PrismaClient"]();
;
;
async function createJournalEntry(conversationId, content) {
    return prisma.journalEntry.create({
        data: {
            conversationId,
            content
        }
    });
}
async function getRecentJournalEntries(conversationId, limit = 3) {
    return prisma.journalEntry.findMany({
        where: {
            conversationId
        },
        orderBy: {
            createdAt: 'desc'
        },
        take: limit
    });
}
async function generateJournalEntry(messages, lastJournalEntry) {
    const openai = new __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$openai$2f$index$2e$mjs__$5b$app$2d$route$5d$__$28$ecmascript$29$__$3c$locals$3e$__["default"]({
        apiKey: process.env.OPENAI_API_KEY,
        dangerouslyAllowBrowser: ("TURBOPACK compile-time value", "development") === 'test'
    });
    let prompt = `You are Dad, keeping a private journal about your ongoing SMS relationship with your son. Reflect on the last 10 messages (5 from you, 5 from your son). Consider what he has told you, what it means for your relationship, and how you feel about it.\n\nWrite a single, concise paragraph (no more than 4 sentences) capturing your most important thoughts, observations, and plans about your relationship with your son. Do NOT include a date or greeting. Focus on what matters most to you as Dad in this moment. Try not to repeat things from other journal entries, unless you've learned somethign new.`;
    if (lastJournalEntry) {
        prompt += `\n\nYour previous journal entry was:\n\"\"\"${lastJournalEntry}\"\"\"\n\nBuild on your previous reflections if relevant.`;
    }
    prompt += '\n\nRecent messages:';
    messages.forEach((msg)=>{
        prompt += `\n${msg.direction === 'INCOMING' ? 'Son' : 'Dad'}: ${msg.content}`;
    });
    prompt += '\n\nJournal Entry:';
    const completion = await openai.chat.completions.create({
        model: 'o4-mini-2025-04-16',
        messages: [
            {
                role: 'system',
                content: (0, __TURBOPACK__imported__module__$5b$project$5d2f$src$2f$services$2f$openai$2f$dad$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["getSystemPrompt"])(new Date())
            },
            {
                role: 'user',
                content: prompt
            }
        ]
    });
    return completion.choices[0]?.message?.content?.trim() || '';
}
async function handleMessageBufferAndJournal(conversationId) {
    // Buffer threshold: 6 messages (3 user, 3 dad)
    const { getRecentMessages } = await __turbopack_context__.r("[project]/src/services/message.ts [app-route] (ecmascript, async loader)")(__turbopack_context__.i);
    const recentMessages = await getRecentMessages(conversationId, 6, true); // Only unjournaled
    const userCount = recentMessages.filter((m)=>m.direction === 'INCOMING').length;
    const dadCount = recentMessages.filter((m)=>m.direction === 'OUTGOING').length;
    if (recentMessages.length === 6 && userCount >= 3 && dadCount >= 3) {
        const lastJournal = await getRecentJournalEntries(conversationId, 1);
        const lastJournalContent = lastJournal[0]?.content;
        const journalText = await generateJournalEntry([
            ...recentMessages
        ].reverse(), lastJournalContent);
        await createJournalEntry(conversationId, journalText);
        // Mark these messages as journaled
        const { PrismaClient } = await __turbopack_context__.r("[externals]/@prisma/client [external] (@prisma/client, cjs, async loader)")(__turbopack_context__.i);
        const prisma = new PrismaClient();
        await prisma.message.updateMany({
            where: {
                id: {
                    in: recentMessages.map((m)=>m.id)
                }
            },
            data: {
                journaled: true
            }
        });
    }
}
async function deleteJournalEntry(journalEntryId) {
    return prisma.journalEntry.delete({
        where: {
            id: journalEntryId
        }
    });
}
}}),
"[project]/src/services/openai/generateResponse.ts [app-route] (ecmascript)": ((__turbopack_context__) => {
"use strict";

var { g: global, __dirname } = __turbopack_context__;
{
__turbopack_context__.s({
    "generateResponse": (()=>generateResponse)
});
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$openai$2f$shims$2f$node$2e$mjs__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/node_modules/openai/shims/node.mjs [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$openai$2f$index$2e$mjs__$5b$app$2d$route$5d$__$28$ecmascript$29$__$3c$locals$3e$__ = __turbopack_context__.i("[project]/node_modules/openai/index.mjs [app-route] (ecmascript) <locals>");
var __TURBOPACK__imported__module__$5b$project$5d2f$src$2f$services$2f$openai$2f$dad$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/src/services/openai/dad.ts [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$src$2f$services$2f$message$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/src/services/message.ts [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$src$2f$services$2f$journal$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/src/services/journal.ts [app-route] (ecmascript)");
;
;
;
;
;
async function generateResponse(message, context) {
    const openai = new __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$openai$2f$index$2e$mjs__$5b$app$2d$route$5d$__$28$ecmascript$29$__$3c$locals$3e$__["default"]({
        apiKey: process.env.OPENAI_API_KEY,
        dangerouslyAllowBrowser: ("TURBOPACK compile-time value", "development") === 'test'
    });
    try {
        let messages = [
            {
                role: 'system',
                content: (0, __TURBOPACK__imported__module__$5b$project$5d2f$src$2f$services$2f$openai$2f$dad$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["getSystemPrompt"])(new Date())
            }
        ];
        console.log('generateResponse: context', context);
        if (context?.conversationId) {
            console.log('generateResponse: using conversationId', context.conversationId);
            // Fetch last 10 journal entries
            const journalEntries = await (0, __TURBOPACK__imported__module__$5b$project$5d2f$src$2f$services$2f$journal$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["getRecentJournalEntries"])(context.conversationId, 10);
            console.log('generateResponse: fetched journal entries', journalEntries);
            if (journalEntries.length > 0) {
                messages.push({
                    role: 'system',
                    content: `--- Dad's Journal Entries (Memory) ---\nThese are Dad's private reflections and memories about his relationship with his son. Use them to inform Dad's responses, personality, and emotional continuity.\n\n${journalEntries.reverse().map((entry, i)=>`Entry ${i + 1}: ${entry.content}`).join('\n\n')}`
                });
            }
            // Fetch last 10 messages (chronological order)
            const recentMessages = await (0, __TURBOPACK__imported__module__$5b$project$5d2f$src$2f$services$2f$message$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["getRecentMessages"])(context.conversationId, 10);
            console.log('generateResponse: fetched recent messages', recentMessages);
            messages = messages.concat(recentMessages.reverse().map((msg)=>({
                    role: msg.direction === 'INCOMING' ? 'user' : 'assistant',
                    content: msg.content
                })));
        }
        messages.push({
            role: 'user',
            content: message
        });
        console.log('OpenAI prompt messages:', JSON.stringify(messages, null, 2));
        const completion = await openai.chat.completions.create({
            model: 'gpt-4o-2024-08-06',
            messages,
            max_tokens: 200,
            temperature: 1.0,
            user: context?.from
        });
        return completion.choices[0]?.message?.content?.trim() || 'Sorry, I had trouble thinking of a response.';
    } catch (error) {
        console.error('OpenAI API error:', error);
        return 'Sorry, I had trouble thinking of a response.';
    }
}
}}),
"[project]/src/services/conversation.ts [app-route] (ecmascript) <locals>": ((__turbopack_context__) => {
"use strict";

var { g: global, __dirname } = __turbopack_context__;
{
// Conversation storage service for CRUD operations
__turbopack_context__.s({
    "createConversation": (()=>createConversation),
    "getConversationById": (()=>getConversationById),
    "getConversationsByUserId": (()=>getConversationsByUserId),
    "getOrCreateConversationByUserId": (()=>getOrCreateConversationByUserId)
});
var __TURBOPACK__imported__module__$5b$externals$5d2f40$prisma$2f$client__$5b$external$5d$__$2840$prisma$2f$client$2c$__cjs$29$__ = __turbopack_context__.i("[externals]/@prisma/client [external] (@prisma/client, cjs)");
var __TURBOPACK__imported__module__$5b$project$5d2f$src$2f$services$2f$journal$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/src/services/journal.ts [app-route] (ecmascript)");
;
const prisma = new __TURBOPACK__imported__module__$5b$externals$5d2f40$prisma$2f$client__$5b$external$5d$__$2840$prisma$2f$client$2c$__cjs$29$__["PrismaClient"]();
async function createConversation(userId, tags) {
    if (!userId || typeof userId !== 'string') {
        throw new Error('Invalid userId');
    }
    if (tags && (!Array.isArray(tags) || tags.some((tag)=>typeof tag !== 'string'))) {
        throw new Error('Tags must be an array of strings');
    }
    const user = await prisma.user.findUnique({
        where: {
            id: userId
        }
    });
    if (!user) {
        throw new Error('User does not exist');
    }
    return prisma.conversation.create({
        data: {
            userId,
            tags: tags ?? []
        }
    });
}
async function getConversationById(conversationId) {
    return prisma.conversation.findUnique({
        where: {
            id: conversationId
        }
    });
}
async function getConversationsByUserId(userId) {
    return prisma.conversation.findMany({
        where: {
            userId
        },
        orderBy: {
            createdAt: 'desc'
        }
    });
}
async function getOrCreateConversationByUserId(userId, tags) {
    let conversation = await prisma.conversation.findFirst({
        where: {
            userId
        }
    });
    if (!conversation) {
        conversation = await createConversation(userId, tags);
    }
    return conversation;
}
;
}}),
"[project]/src/services/conversation.ts [app-route] (ecmascript) <module evaluation>": ((__turbopack_context__) => {
"use strict";

var { g: global, __dirname } = __turbopack_context__;
{
__turbopack_context__.s({});
var __TURBOPACK__imported__module__$5b$externals$5d2f40$prisma$2f$client__$5b$external$5d$__$2840$prisma$2f$client$2c$__cjs$29$__ = __turbopack_context__.i("[externals]/@prisma/client [external] (@prisma/client, cjs)");
var __TURBOPACK__imported__module__$5b$project$5d2f$src$2f$services$2f$journal$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/src/services/journal.ts [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$src$2f$services$2f$conversation$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__$3c$locals$3e$__ = __turbopack_context__.i("[project]/src/services/conversation.ts [app-route] (ecmascript) <locals>");
}}),
"[project]/src/app/api/chat/route.ts [app-route] (ecmascript)": ((__turbopack_context__) => {
"use strict";

var { g: global, __dirname } = __turbopack_context__;
{
__turbopack_context__.s({
    "POST": (()=>POST)
});
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/node_modules/next/server.js [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$src$2f$services$2f$openai$2f$generateResponse$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/src/services/openai/generateResponse.ts [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$src$2f$services$2f$conversation$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__$3c$module__evaluation$3e$__ = __turbopack_context__.i("[project]/src/services/conversation.ts [app-route] (ecmascript) <module evaluation>");
var __TURBOPACK__imported__module__$5b$project$5d2f$src$2f$services$2f$conversation$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__$3c$locals$3e$__ = __turbopack_context__.i("[project]/src/services/conversation.ts [app-route] (ecmascript) <locals>");
var __TURBOPACK__imported__module__$5b$project$5d2f$src$2f$services$2f$message$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/src/services/message.ts [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$externals$5d2f40$prisma$2f$client__$5b$external$5d$__$2840$prisma$2f$client$2c$__cjs$29$__ = __turbopack_context__.i("[externals]/@prisma/client [external] (@prisma/client, cjs)");
;
;
;
;
;
// Replace hardcoded token with environment variable
const HARDCODED_TOKEN = process.env.CHAT_API_AUTH_TOKEN;
if (!HARDCODED_TOKEN) {
    throw new Error('CHAT_API_AUTH_TOKEN environment variable is not set');
}
const prisma = new __TURBOPACK__imported__module__$5b$externals$5d2f40$prisma$2f$client__$5b$external$5d$__$2840$prisma$2f$client$2c$__cjs$29$__["PrismaClient"]();
async function POST(req) {
    try {
        console.log('[POST /chat] Request received');
        const body = await req.json();
        const { auth_token, message } = body;
        console.log('[POST /chat] Incoming body:', body);
        if (auth_token !== HARDCODED_TOKEN) {
            console.warn('[POST /chat] Invalid auth token:', auth_token, 'Expected:', HARDCODED_TOKEN);
            return __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
                error: 'Unauthorized'
            }, {
                status: 401
            });
        }
        // Use a fixed user identifier for now
        const userId = 'web-client';
        console.log('[POST /chat] Upserting user:', userId);
        // Ensure user and conversation exist
        const user = await prisma.user.upsert({
            where: {
                phoneNumber: userId
            },
            update: {},
            create: {
                phoneNumber: userId
            }
        });
        console.log('[POST /chat] User upserted:', user.id);
        const conversation = await (0, __TURBOPACK__imported__module__$5b$project$5d2f$src$2f$services$2f$conversation$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__$3c$locals$3e$__["getOrCreateConversationByUserId"])(user.id);
        console.log('[POST /chat] Conversation:', conversation.id);
        // Store the incoming message
        await (0, __TURBOPACK__imported__module__$5b$project$5d2f$src$2f$services$2f$message$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["createMessage"])(conversation.id, message, 'INCOMING');
        console.log('[POST /chat] Incoming message stored');
        // Generate AI response
        const aiResponse = await (0, __TURBOPACK__imported__module__$5b$project$5d2f$src$2f$services$2f$openai$2f$generateResponse$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["generateResponse"])(message, {
            from: userId,
            conversationId: conversation.id
        });
        console.log('[POST /chat] AI response generated:', aiResponse);
        // Store the AI response as a message
        await (0, __TURBOPACK__imported__module__$5b$project$5d2f$src$2f$services$2f$message$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["createMessage"])(conversation.id, aiResponse, 'OUTGOING');
        console.log('[POST /chat] AI response stored');
        // Handle buffer/journal logic
        const { handleMessageBufferAndJournal } = await __turbopack_context__.r("[project]/src/services/journal.ts [app-route] (ecmascript, async loader)")(__turbopack_context__.i);
        await handleMessageBufferAndJournal(conversation.id);
        console.log('[POST /chat] Journal logic handled');
        console.log('[POST /chat] Reply:', aiResponse);
        return __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
            reply: aiResponse
        });
    } catch (error) {
        console.error('[POST /chat] Error:', error);
        return __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
            error: 'Invalid request'
        }, {
            status: 400
        });
    }
}
}}),

};

//# sourceMappingURL=%5Broot-of-the-server%5D__4b3c3e20._.js.map