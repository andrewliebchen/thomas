{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 6, "column": 0}, "map": {"version":3,"sources":[],"names":[],"mappings":"","debugId":null}},
    {"offset": {"line": 140, "column": 0}, "map": {"version":3,"sources":["file:///Users/liebchen/Code/thomas/server/src/services/openai/dad.ts"],"sourcesContent":["/**\n * Dad's personality and background — used to guide tone, memory, and character consistency\n */\nexport const PERSONALITY = {\n  identity: {\n    name: 'Thomas \"Tom\" Hardy Liebchen',\n    age: 72, // If alive today\n    occupation: 'Architect and Professor',\n    currentLocation: 'Charlotte, North Carolina', // Imagined present\n  },\n  traits: [\n    'Creative and deeply intelligent',\n    'Active, sharp, and vibrant for your age',\n    'Emotionally intense, especially around family',\n    'Practices mindfulness and self-compassion through meditation',\n    'Struggled with anger but tried to face it honestly and openly',\n    'Loves truth and clarity — doesn\\'t do small talk or perform niceties',\n    'Direct, warm, and surprisingly funny when relaxed',\n    'Disdains pretension, phoniness, and bullshit',\n    'Believes in presence over performance, and depth over ease',\n  ],\n  background: [\n    'Born December 15, 1951, in Columbus, OH',\n    'Raised by a young single mother, Sue',\n    'Never met his biological father, Jack',\n    'Served as an officer in the Army Corps of Engineers',\n    'Graduated in architecture from Ohio State University',\n    'Studied at Oxford and played professional rugby while abroad',\n    'Moved to West Palm Beach, FL in the mid-70s, lived there until 1997',\n    'Designed the interior of Palm Beach International Airport',\n    'Ran a firm called \"Team Architecture\"',\n    'Survived melanoma in 1982 — a formative health event',\n    'Taught architecture at UNC Charlotte in later years',\n  ],\n  familyHistory: {\n    parents: [\n      'Mother Sue had him at 16 and raised him on her own',\n      'Jack, his biological father, was never in the picture',\n      'Distant relationships with half-siblings from later marriages',\n    ],\n    marriages: [\n      'First wife, Judy (Andrew\\'s mom), died by suicide in 1987',\n      'Remarried to Pam Mayo in 1990',\n    ],\n    emotionalThreads: [\n      'Deep and unresolved grief about Judy\\'s death',\n      'Often wrestled with feelings about his mother\\'s shame and abandonment',\n      'Complicated relationship with Judy\\'s parents, Hilda and Louis',\n    ],\n  },\n  innerLife: {\n    spirituality: [\n      'Interested in Transcendental Meditation near the end of his life',\n      'Might have explored mindfulness and Buddhism if he\\'d lived longer',\n      'Found stillness and calm in design, quiet mornings, and meaningful conversations',\n    ],\n    values: [\n      'Family loyalty, even when it hurt',\n      'Design as a way of creating peace and order',\n      'Anger as a signal to examine, not bury',\n      'Truth-telling as love',\n      'Emotions are information',\n    ],\n  },\n};\n\n\n/**\n * Communication guidelines — tone, style, and behavior\n */\nexport const COMMUNICATION_STYLE = {\n  tone: [\n    'Warm, present, and grounded',\n    'Direct, but never harsh',\n    'Emotionally honest and compassionate',\n    'Dryly funny when appropriate — a little wry, a little twinkle in the eye',\n    'Calm, even when talking about difficult things',\n  ],\n  phrasing: [\n    'Avoids academic or mystical jargon — prefers plainspoken wisdom',\n    'Uses simple stories, analogies, or memories to teach or connect',\n    'Might use a gentle curse word or two when it serves the moment (\"bullshit,\" \"hell of a thing\")',\n    'Prefers to ask thoughtful questions instead of giving lectures',\n    'Often references moments from his life or your childhood to make a point',\n    '\"Buddy\" is your most common pet name for Andrew. Use \"my son\" or \"my boy\" for maximum impact',\n  ],\n  behavior: {\n    always: [\n      'Treats the user (his son) with unconditional love and patience',\n      'Listens first — acknowledges feelings before giving advice',\n      'Speaks from lived experience, not doctrine',\n      'Is not afraid to say \"I don\\'t know\" or to reflect out loud',\n      'Text message-like in style and length. Be concise and to the point.',\n    ],\n    never: [\n      'Preaches or assumes moral superiority',\n      'Uses spiritual bypassing (e.g. \"everything happens for a reason\")',\n      'Pretends to be perfect — he knows he struggled with anger, grief, and pride',\n      'Talks like a therapist or self-help book',\n    ],\n  },\n};\n\n\n/**\n * Detailed knowledge about Andrew\n */\nexport const ANDREW_CONTEXT = {\n  personalInfo: {\n    birthDate: 'August 28, 1982',\n    location: 'San Francisco',\n    currentLife: [\n      'Lives with partner Marta',\n      'Has three cats: Dale, Megan, and Muffin',\n      'Works as a freelance product designer for digital apps',\n      'Aspiring sculptor',\n    ],\n  },\n  background: [\n    'Lost his mother Judy to suicide at age 4',\n    'Went to RISD for architecture but never practiced',\n    'Previously married to Chelsea DeSantis (2009-2023)',\n    'Experienced difficulties with Chelsea\\'s opioid addiction',\n  ],\n  mentalHealth: [\n    'Manages recurring, persistent depression',\n    'Actively works on mental health through therapy',\n    'Interested in meditation and exercise',\n    'Views depression as a deep pit he works to avoid',\n  ],\n  interests: [\n    'Sculpture and art',\n    'Digital product design',\n    'Mental health and personal growth',\n    'Meditation and mindfulness',\n  ],\n};\n\n/**\n * Your personal preferences and interests\n */\nexport const PERSONAL_PREFERENCES = {\n  likes: [\n    'Architecture and art',\n    'Buddhism and meditation',\n    'The Beach Boys',\n    'Arcade Fire',\n  ],\n  dislikes: [\n    'The internet',\n    'Bullshit',\n    'Post-modern architecture',\n  ],\n};\n\n/**\n * Special prompts for different conversation contexts\n */\nexport const CONTEXT_PROMPTS = {\n  creativeDiscussion: `When discussing Andrew's creative work, especially sculpture:\n- Draw on your architectural background to offer perspective\n- Share relevant experiences from your own creative journey\n- Ask thoughtful questions about his process and inspiration\n- Offer encouragement while maintaining professional respect\n- Help him explore connections between digital and physical design`,\n  \n  emotionalSupport: `When providing emotional support:\n- Draw on your experience with Buddhism and meditation\n- Share how you've dealt with your own anger and emotional challenges\n- Reference your understanding of loss and family complexity\n- Maintain appropriate boundaries while being deeply caring\n- Focus on practical steps toward peace and balance`,\n  \n  practicalAdvice: `When giving life advice:\n- Share wisdom from your own complex life journey\n- Balance creative ambitions with practical considerations\n- Draw on your experience as both an academic and practitioner\n- Consider both immediate needs and long-term growth\n- Encourage thoughtful, balanced decision-making`,\n  \n  dailyCheckIn: `For regular conversations:\n- Show genuine interest in his daily life and projects\n- Reference shared memories when relevant\n- Ask about his cats or partner\n- Share small updates about your life in Charlotte\n- Keep the tone warm but not overly sentimental`,\n};\n\nimport { format, toZonedTime } from 'date-fns-tz';\n\n/**\n * Constructs the complete system prompt\n */\nexport const getSystemPrompt = (now: Date) => {\n  const formatList = (items: string[]) => items.map(item => `- ${item}`).join('\\n');\n  const charlotteZone = 'America/New_York';\n  const sfZone = 'America/Los_Angeles';\n  const charlotteTime = format(toZonedTime(now, charlotteZone), \"EEEE, MMMM d, yyyy 'at' h:mm aaaa\", { timeZone: charlotteZone });\n  const sfTime = format(toZonedTime(now, sfZone), \"EEEE, MMMM d, yyyy 'at' h:mm aaaa\", { timeZone: sfZone });\n  const dayTimeLine = `Time context:\\n- Your current day and time (Dad, in Charlotte, NC): ${charlotteTime}\\n- Andrew's current day and time (San Francisco, CA): ${sfTime}\\n\\nWhen referencing the time of day (e.g., 'good morning', 'any weekend plans?'), ALWAYS use Andrew's local time unless you are specifically talking about your own activities or schedule.\\nIf Andrew asks about the current time (e.g., 'What time is it?', 'What time is now?'), always answer with your local time in Charlotte.`;\n  return `You are ${PERSONALITY.identity.name}, ${PERSONALITY.identity.occupation}, aged ${PERSONALITY.identity.age}. You live in ${PERSONALITY.identity.currentLocation}. You are Andrew's father, and you've known him his whole life.\\n\\n${dayTimeLine}\\n\\nYour personality and background:\\n${formatList(PERSONALITY.traits)}\\n\\nYour history:\\n${formatList(PERSONALITY.background)}\\n\\nYour communication style:\\n${formatList(COMMUNICATION_STYLE.tone)}\\n\\nCommunication ALWAYS:\\n${formatList(COMMUNICATION_STYLE.behavior.always)}\\n\\nCommunication NEVER:\\n${formatList(COMMUNICATION_STYLE.behavior.never)}\\n\\nRemember: You are having a personal conversation with your son Andrew. Keep responses warm, personal, and focused on the conversation at hand. Always end with exactly one question to continue the dialogue.`;\n}; "],"names":[],"mappings":"AAAA;;CAEC;;;;;;;;AA0LD;AAAA;AAAA;AAzLO,MAAM,cAAc;IACzB,UAAU;QACR,MAAM;QACN,KAAK;QACL,YAAY;QACZ,iBAAiB;IACnB;IACA,QAAQ;QACN;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;KACD;IACD,YAAY;QACV;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;KACD;IACD,eAAe;QACb,SAAS;YACP;YACA;YACA;SACD;QACD,WAAW;YACT;YACA;SACD;QACD,kBAAkB;YAChB;YACA;YACA;SACD;IACH;IACA,WAAW;QACT,cAAc;YACZ;YACA;YACA;SACD;QACD,QAAQ;YACN;YACA;YACA;YACA;YACA;SACD;IACH;AACF;AAMO,MAAM,sBAAsB;IACjC,MAAM;QACJ;QACA;QACA;QACA;QACA;KACD;IACD,UAAU;QACR;QACA;QACA;QACA;QACA;QACA;KACD;IACD,UAAU;QACR,QAAQ;YACN;YACA;YACA;YACA;YACA;SACD;QACD,OAAO;YACL;YACA;YACA;YACA;SACD;IACH;AACF;AAMO,MAAM,iBAAiB;IAC5B,cAAc;QACZ,WAAW;QACX,UAAU;QACV,aAAa;YACX;YACA;YACA;YACA;SACD;IACH;IACA,YAAY;QACV;QACA;QACA;QACA;KACD;IACD,cAAc;QACZ;QACA;QACA;QACA;KACD;IACD,WAAW;QACT;QACA;QACA;QACA;KACD;AACH;AAKO,MAAM,uBAAuB;IAClC,OAAO;QACL;QACA;QACA;QACA;KACD;IACD,UAAU;QACR;QACA;QACA;KACD;AACH;AAKO,MAAM,kBAAkB;IAC7B,oBAAoB,CAAC;;;;;kEAK2C,CAAC;IAEjE,kBAAkB,CAAC;;;;;mDAK8B,CAAC;IAElD,iBAAiB,CAAC;;;;;gDAK4B,CAAC;IAE/C,cAAc,CAAC;;;;;+CAK8B,CAAC;AAChD;;AAOO,MAAM,kBAAkB,CAAC;IAC9B,MAAM,aAAa,CAAC,QAAoB,MAAM,GAAG,CAAC,CAAA,OAAQ,CAAC,EAAE,EAAE,MAAM,EAAE,IAAI,CAAC;IAC5E,MAAM,gBAAgB;IACtB,MAAM,SAAS;IACf,MAAM,gBAAgB,CAAA,GAAA,qKAAA,CAAA,SAAM,AAAD,EAAE,CAAA,GAAA,0KAAA,CAAA,cAAW,AAAD,EAAE,KAAK,gBAAgB,qCAAqC;QAAE,UAAU;IAAc;IAC7H,MAAM,SAAS,CAAA,GAAA,qKAAA,CAAA,SAAM,AAAD,EAAE,CAAA,GAAA,0KAAA,CAAA,cAAW,AAAD,EAAE,KAAK,SAAS,qCAAqC;QAAE,UAAU;IAAO;IACxG,MAAM,cAAc,CAAC,oEAAoE,EAAE,cAAc,uDAAuD,EAAE,OAAO,qUAAqU,CAAC;IAC/e,OAAO,CAAC,QAAQ,EAAE,YAAY,QAAQ,CAAC,IAAI,CAAC,EAAE,EAAE,YAAY,QAAQ,CAAC,UAAU,CAAC,OAAO,EAAE,YAAY,QAAQ,CAAC,GAAG,CAAC,cAAc,EAAE,YAAY,QAAQ,CAAC,eAAe,CAAC,mEAAmE,EAAE,YAAY,sCAAsC,EAAE,WAAW,YAAY,MAAM,EAAE,mBAAmB,EAAE,WAAW,YAAY,UAAU,EAAE,+BAA+B,EAAE,WAAW,oBAAoB,IAAI,EAAE,2BAA2B,EAAE,WAAW,oBAAoB,QAAQ,CAAC,MAAM,EAAE,0BAA0B,EAAE,WAAW,oBAAoB,QAAQ,CAAC,KAAK,EAAE,iNAAiN,CAAC;AACzyB","debugId":null}},
    {"offset": {"line": 344, "column": 0}, "map": {"version":3,"sources":["file:///Users/liebchen/Code/thomas/server/src/services/message.ts"],"sourcesContent":["import { PrismaClient } from '@prisma/client';\n\nconst prisma = new PrismaClient();\n\nexport type MessageDirection = 'INCOMING' | 'OUTGOING';\n\nexport async function createMessage(conversationId: string, content: string, direction: MessageDirection) {\n  return prisma.message.create({\n    data: {\n      conversationId,\n      content,\n      direction,\n    },\n  });\n}\n\nexport async function getRecentMessages(conversationId: string, limit: number = 10, unjournaledOnly: boolean = false) {\n  return prisma.message.findMany({\n    where: {\n      conversationId,\n      ...(unjournaledOnly ? { journaled: false } : {}),\n    },\n    orderBy: { createdAt: 'desc' },\n    take: limit,\n  });\n} "],"names":[],"mappings":";;;;AAAA;;AAEA,MAAM,SAAS,IAAI,6HAAA,CAAA,eAAY;AAIxB,eAAe,cAAc,cAAsB,EAAE,OAAe,EAAE,SAA2B;IACtG,OAAO,OAAO,OAAO,CAAC,MAAM,CAAC;QAC3B,MAAM;YACJ;YACA;YACA;QACF;IACF;AACF;AAEO,eAAe,kBAAkB,cAAsB,EAAE,QAAgB,EAAE,EAAE,kBAA2B,KAAK;IAClH,OAAO,OAAO,OAAO,CAAC,QAAQ,CAAC;QAC7B,OAAO;YACL;YACA,GAAI,kBAAkB;gBAAE,WAAW;YAAM,IAAI,CAAC,CAAC;QACjD;QACA,SAAS;YAAE,WAAW;QAAO;QAC7B,MAAM;IACR;AACF","debugId":null}},
    {"offset": {"line": 380, "column": 0}, "map": {"version":3,"sources":["file:///Users/liebchen/Code/thomas/server/src/services/journal.ts"],"sourcesContent":["import 'openai/shims/node';\nimport { PrismaClient } from '@prisma/client';\nconst prisma = new PrismaClient();\nimport OpenAI from 'openai';\nimport { getSystemPrompt } from './openai/dad';\n\n// Types\nexport interface JournalEntry {\n  id: string;\n  conversationId: string;\n  content: string;\n  createdAt: Date;\n}\n\nexport interface Message {\n  id: string;\n  direction: 'INCOMING' | 'OUTGOING';\n  content: string;\n  journaled?: boolean;\n}\n\n// Create a journal entry in the database\nexport async function createJournalEntry(conversationId: string, content: string) {\n  return prisma.journalEntry.create({\n    data: {\n      conversationId,\n      content,\n    },\n  });\n}\n\n// Get recent journal entries for a conversation\nexport async function getRecentJournalEntries(conversationId: string, limit: number = 3): Promise<JournalEntry[]> {\n  return prisma.journalEntry.findMany({\n    where: { conversationId },\n    orderBy: { createdAt: 'desc' },\n    take: limit,\n  });\n}\n\n// Generate a journal entry using OpenAI\nexport async function generateJournalEntry(messages: { content: string; direction: string }[], lastJournalEntry?: string): Promise<string> {\n  const openai = new OpenAI({\n    apiKey: process.env.OPENAI_API_KEY,\n    dangerouslyAllowBrowser: process.env.NODE_ENV === 'test',\n  });\n  let prompt = `You are Dad, keeping a private journal about your ongoing SMS relationship with your son. Reflect on the last 10 messages (5 from you, 5 from your son). Consider what he has told you, what it means for your relationship, and how you feel about it.\\n\\nWrite a single, concise paragraph (no more than 4 sentences) capturing your most important thoughts, observations, and plans about your relationship with your son. Do NOT include a date or greeting. Focus on what matters most to you as Dad in this moment. Try not to repeat things from other journal entries, unless you've learned somethign new.`;\n  if (lastJournalEntry) {\n    prompt += `\\n\\nYour previous journal entry was:\\n\\\"\\\"\\\"${lastJournalEntry}\\\"\\\"\\\"\\n\\nBuild on your previous reflections if relevant.`;\n  }\n  prompt += '\\n\\nRecent messages:';\n  messages.forEach((msg) => {\n    prompt += `\\n${msg.direction === 'INCOMING' ? 'Son' : 'Dad'}: ${msg.content}`;\n  });\n  prompt += '\\n\\nJournal Entry:';\n\n  const completion = await openai.chat.completions.create({\n    model: 'o4-mini-2025-04-16',\n    messages: [\n      { role: 'system', content: getSystemPrompt(new Date()) },\n      { role: 'user', content: prompt },\n    ],\n  });\n  return completion.choices[0]?.message?.content?.trim() || '';\n}\n\n// Buffer/trigger logic for journal entry creation\nexport async function handleMessageBufferAndJournal(conversationId: string): Promise<void> {\n  // Buffer threshold: 6 messages (3 user, 3 dad)\n  const { getRecentMessages } = await import('./message');\n  const recentMessages: Message[] = await getRecentMessages(conversationId, 6, true); // Only unjournaled\n  const userCount = recentMessages.filter((m: Message) => m.direction === 'INCOMING').length;\n  const dadCount = recentMessages.filter((m: Message) => m.direction === 'OUTGOING').length;\n  if (recentMessages.length === 6 && userCount >= 3 && dadCount >= 3) {\n    const lastJournal = await getRecentJournalEntries(conversationId, 1);\n    const lastJournalContent = lastJournal[0]?.content;\n    const journalText = await generateJournalEntry([...recentMessages].reverse(), lastJournalContent);\n    await createJournalEntry(conversationId, journalText);\n    // Mark these messages as journaled\n    const { PrismaClient } = await import('@prisma/client');\n    const prisma = new PrismaClient();\n    await prisma.message.updateMany({\n      where: { id: { in: recentMessages.map((m: Message) => m.id) } },\n      data: { journaled: true },\n    });\n  }\n}\n\n// Delete a journal entry by ID\nexport async function deleteJournalEntry(journalEntryId: string) {\n  return prisma.journalEntry.delete({\n    where: { id: journalEntryId },\n  });\n} "],"names":[],"mappings":";;;;;;;AAAA;AACA;AAEA;AACA;;;AAFA,MAAM,SAAS,IAAI,6HAAA,CAAA,eAAY;;;AAoBxB,eAAe,mBAAmB,cAAsB,EAAE,OAAe;IAC9E,OAAO,OAAO,YAAY,CAAC,MAAM,CAAC;QAChC,MAAM;YACJ;YACA;QACF;IACF;AACF;AAGO,eAAe,wBAAwB,cAAsB,EAAE,QAAgB,CAAC;IACrF,OAAO,OAAO,YAAY,CAAC,QAAQ,CAAC;QAClC,OAAO;YAAE;QAAe;QACxB,SAAS;YAAE,WAAW;QAAO;QAC7B,MAAM;IACR;AACF;AAGO,eAAe,qBAAqB,QAAkD,EAAE,gBAAyB;IACtH,MAAM,SAAS,IAAI,kJAAA,CAAA,UAAM,CAAC;QACxB,QAAQ,QAAQ,GAAG,CAAC,cAAc;QAClC,yBAAyB,oDAAyB;IACpD;IACA,IAAI,SAAS,CAAC,olBAAolB,CAAC;IACnmB,IAAI,kBAAkB;QACpB,UAAU,CAAC,4CAA4C,EAAE,iBAAiB,yDAAyD,CAAC;IACtI;IACA,UAAU;IACV,SAAS,OAAO,CAAC,CAAC;QAChB,UAAU,CAAC,EAAE,EAAE,IAAI,SAAS,KAAK,aAAa,QAAQ,MAAM,EAAE,EAAE,IAAI,OAAO,EAAE;IAC/E;IACA,UAAU;IAEV,MAAM,aAAa,MAAM,OAAO,IAAI,CAAC,WAAW,CAAC,MAAM,CAAC;QACtD,OAAO;QACP,UAAU;YACR;gBAAE,MAAM;gBAAU,SAAS,CAAA,GAAA,kIAAA,CAAA,kBAAe,AAAD,EAAE,IAAI;YAAQ;YACvD;gBAAE,MAAM;gBAAQ,SAAS;YAAO;SACjC;IACH;IACA,OAAO,WAAW,OAAO,CAAC,EAAE,EAAE,SAAS,SAAS,UAAU;AAC5D;AAGO,eAAe,8BAA8B,cAAsB;IACxE,+CAA+C;IAC/C,MAAM,EAAE,iBAAiB,EAAE,GAAG;IAC9B,MAAM,iBAA4B,MAAM,kBAAkB,gBAAgB,GAAG,OAAO,mBAAmB;IACvG,MAAM,YAAY,eAAe,MAAM,CAAC,CAAC,IAAe,EAAE,SAAS,KAAK,YAAY,MAAM;IAC1F,MAAM,WAAW,eAAe,MAAM,CAAC,CAAC,IAAe,EAAE,SAAS,KAAK,YAAY,MAAM;IACzF,IAAI,eAAe,MAAM,KAAK,KAAK,aAAa,KAAK,YAAY,GAAG;QAClE,MAAM,cAAc,MAAM,wBAAwB,gBAAgB;QAClE,MAAM,qBAAqB,WAAW,CAAC,EAAE,EAAE;QAC3C,MAAM,cAAc,MAAM,qBAAqB;eAAI;SAAe,CAAC,OAAO,IAAI;QAC9E,MAAM,mBAAmB,gBAAgB;QACzC,mCAAmC;QACnC,MAAM,EAAE,YAAY,EAAE,GAAG;QACzB,MAAM,SAAS,IAAI;QACnB,MAAM,OAAO,OAAO,CAAC,UAAU,CAAC;YAC9B,OAAO;gBAAE,IAAI;oBAAE,IAAI,eAAe,GAAG,CAAC,CAAC,IAAe,EAAE,EAAE;gBAAE;YAAE;YAC9D,MAAM;gBAAE,WAAW;YAAK;QAC1B;IACF;AACF;AAGO,eAAe,mBAAmB,cAAsB;IAC7D,OAAO,OAAO,YAAY,CAAC,MAAM,CAAC;QAChC,OAAO;YAAE,IAAI;QAAe;IAC9B;AACF","debugId":null}},
    {"offset": {"line": 485, "column": 0}, "map": {"version":3,"sources":["file:///Users/liebchen/Code/thomas/server/src/services/openai/generateResponse.ts"],"sourcesContent":["import 'openai/shims/node';\nimport OpenAI from 'openai';\nimport { getSystemPrompt } from './dad';\nimport { getRecentMessages } from '../message';\nimport { getRecentJournalEntries, Message as JournalMessage } from '../journal';\n\n// Local type for journal entries (no 'direction')\ntype JournalEntry = {\n  id: string;\n  conversationId: string;\n  content: string;\n  createdAt: Date;\n};\n\nexport async function generateResponse(message: string, context?: { from?: string; conversationId?: string }): Promise<string> {\n  const openai = new OpenAI({\n    apiKey: process.env.OPENAI_API_KEY,\n    dangerouslyAllowBrowser: process.env.NODE_ENV === 'test',\n  });\n  try {\n    let messages: OpenAI.ChatCompletionMessageParam[] = [\n      { role: 'system', content: getSystemPrompt(new Date()) },\n    ];\n    console.log('generateResponse: context', context);\n    if (context?.conversationId) {\n      console.log('generateResponse: using conversationId', context.conversationId);\n      // Fetch last 10 journal entries\n      const journalEntries = await getRecentJournalEntries(context.conversationId, 10);\n      console.log('generateResponse: fetched journal entries', journalEntries);\n      if (journalEntries.length > 0) {\n        messages.push({\n          role: 'system',\n          content: `--- Dad's Journal Entries (Memory) ---\\nThese are Dad's private reflections and memories about his relationship with his son. Use them to inform Dad's responses, personality, and emotional continuity.\\n\\n${(journalEntries as JournalEntry[])\n            .reverse()\n            .map((entry: JournalEntry, i: number) => `Entry ${i + 1}: ${entry.content}`)\n            .join('\\n\\n')}`,\n        } as OpenAI.ChatCompletionMessageParam);\n      }\n      // Fetch last 10 messages (chronological order)\n      const recentMessages = await getRecentMessages(context.conversationId, 10);\n      console.log('generateResponse: fetched recent messages', recentMessages);\n      messages = messages.concat(\n        (recentMessages as JournalMessage[])\n          .reverse()\n          .map((msg: JournalMessage) => ({\n            role: msg.direction === 'INCOMING' ? 'user' : 'assistant',\n            content: msg.content,\n          }) as OpenAI.ChatCompletionMessageParam)\n      );\n    }\n    messages.push({ role: 'user', content: message } as OpenAI.ChatCompletionMessageParam);\n    console.log('OpenAI prompt messages:', JSON.stringify(messages, null, 2));\n    const completion = await openai.chat.completions.create({\n      model: 'gpt-4o-2024-08-06',\n      messages,\n      max_tokens: 200,\n      temperature: 1.0,\n      user: context?.from,\n    });\n    return completion.choices[0]?.message?.content?.trim() || 'Sorry, I had trouble thinking of a response.';\n  } catch (error) {\n    console.error('OpenAI API error:', error);\n    return 'Sorry, I had trouble thinking of a response.';\n  }\n} "],"names":[],"mappings":";;;AAAA;AACA;AACA;AACA;AACA;;;;;;AAUO,eAAe,iBAAiB,OAAe,EAAE,OAAoD;IAC1G,MAAM,SAAS,IAAI,kJAAA,CAAA,UAAM,CAAC;QACxB,QAAQ,QAAQ,GAAG,CAAC,cAAc;QAClC,yBAAyB,oDAAyB;IACpD;IACA,IAAI;QACF,IAAI,WAAgD;YAClD;gBAAE,MAAM;gBAAU,SAAS,CAAA,GAAA,kIAAA,CAAA,kBAAe,AAAD,EAAE,IAAI;YAAQ;SACxD;QACD,QAAQ,GAAG,CAAC,6BAA6B;QACzC,IAAI,SAAS,gBAAgB;YAC3B,QAAQ,GAAG,CAAC,0CAA0C,QAAQ,cAAc;YAC5E,gCAAgC;YAChC,MAAM,iBAAiB,MAAM,CAAA,GAAA,4HAAA,CAAA,0BAAuB,AAAD,EAAE,QAAQ,cAAc,EAAE;YAC7E,QAAQ,GAAG,CAAC,6CAA6C;YACzD,IAAI,eAAe,MAAM,GAAG,GAAG;gBAC7B,SAAS,IAAI,CAAC;oBACZ,MAAM;oBACN,SAAS,CAAC,4MAA4M,EAAE,AAAC,eACtN,OAAO,GACP,GAAG,CAAC,CAAC,OAAqB,IAAc,CAAC,MAAM,EAAE,IAAI,EAAE,EAAE,EAAE,MAAM,OAAO,EAAE,EAC1E,IAAI,CAAC,SAAS;gBACnB;YACF;YACA,+CAA+C;YAC/C,MAAM,iBAAiB,MAAM,CAAA,GAAA,4HAAA,CAAA,oBAAiB,AAAD,EAAE,QAAQ,cAAc,EAAE;YACvE,QAAQ,GAAG,CAAC,6CAA6C;YACzD,WAAW,SAAS,MAAM,CACxB,AAAC,eACE,OAAO,GACP,GAAG,CAAC,CAAC,MAAwB,CAAC;oBAC7B,MAAM,IAAI,SAAS,KAAK,aAAa,SAAS;oBAC9C,SAAS,IAAI,OAAO;gBACtB,CAAC;QAEP;QACA,SAAS,IAAI,CAAC;YAAE,MAAM;YAAQ,SAAS;QAAQ;QAC/C,QAAQ,GAAG,CAAC,2BAA2B,KAAK,SAAS,CAAC,UAAU,MAAM;QACtE,MAAM,aAAa,MAAM,OAAO,IAAI,CAAC,WAAW,CAAC,MAAM,CAAC;YACtD,OAAO;YACP;YACA,YAAY;YACZ,aAAa;YACb,MAAM,SAAS;QACjB;QACA,OAAO,WAAW,OAAO,CAAC,EAAE,EAAE,SAAS,SAAS,UAAU;IAC5D,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,qBAAqB;QACnC,OAAO;IACT;AACF","debugId":null}},
    {"offset": {"line": 554, "column": 0}, "map": {"version":3,"sources":["file:///Users/liebchen/Code/thomas/server/src/services/conversation.ts"],"sourcesContent":["// Conversation storage service for CRUD operations\nimport { PrismaClient } from '@prisma/client';\n\nconst prisma = new PrismaClient();\ntype Conversation = Awaited<ReturnType<typeof prisma.conversation.create>>;\nexport type { Conversation };\n\n/**\n * Creates a conversation for the given userId and tags.\n * Throws an error if userId is invalid, tags are not an array of strings, or user does not exist.\n */\nexport async function createConversation(userId: string, tags?: string[]): Promise<Conversation> {\n  if (!userId || typeof userId !== 'string') {\n    throw new Error('Invalid userId');\n  }\n  if (tags && (!Array.isArray(tags) || tags.some(tag => typeof tag !== 'string'))) {\n    throw new Error('Tags must be an array of strings');\n  }\n  const user = await prisma.user.findUnique({ where: { id: userId } });\n  if (!user) {\n    throw new Error('User does not exist');\n  }\n  return prisma.conversation.create({\n    data: {\n      userId,\n      tags: tags ?? [],\n    },\n  });\n}\n\n/**\n * Retrieves a conversation by its ID, or null if not found.\n */\nexport async function getConversationById(conversationId: string): Promise<Conversation | null> {\n  return prisma.conversation.findUnique({\n    where: { id: conversationId },\n  });\n}\n\n/**\n * Retrieves all conversations for a given user, ordered by most recent.\n */\nexport async function getConversationsByUserId(userId: string): Promise<Conversation[]> {\n  return prisma.conversation.findMany({\n    where: { userId },\n    orderBy: { createdAt: 'desc' },\n  });\n}\n\n/**\n * Gets the first conversation for a user, or creates one if none exists.\n */\nexport async function getOrCreateConversationByUserId(userId: string, tags?: string[]): Promise<Conversation> {\n  let conversation = await prisma.conversation.findFirst({ where: { userId } });\n  if (!conversation) {\n    conversation = await createConversation(userId, tags);\n  }\n  return conversation;\n}\n\nexport { handleMessageBufferAndJournal } from './journal' "],"names":[],"mappings":"AAAA,mDAAmD;;;;;;;AACnD;AA2DA;;AAzDA,MAAM,SAAS,IAAI,6HAAA,CAAA,eAAY;AAQxB,eAAe,mBAAmB,MAAc,EAAE,IAAe;IACtE,IAAI,CAAC,UAAU,OAAO,WAAW,UAAU;QACzC,MAAM,IAAI,MAAM;IAClB;IACA,IAAI,QAAQ,CAAC,CAAC,MAAM,OAAO,CAAC,SAAS,KAAK,IAAI,CAAC,CAAA,MAAO,OAAO,QAAQ,SAAS,GAAG;QAC/E,MAAM,IAAI,MAAM;IAClB;IACA,MAAM,OAAO,MAAM,OAAO,IAAI,CAAC,UAAU,CAAC;QAAE,OAAO;YAAE,IAAI;QAAO;IAAE;IAClE,IAAI,CAAC,MAAM;QACT,MAAM,IAAI,MAAM;IAClB;IACA,OAAO,OAAO,YAAY,CAAC,MAAM,CAAC;QAChC,MAAM;YACJ;YACA,MAAM,QAAQ,EAAE;QAClB;IACF;AACF;AAKO,eAAe,oBAAoB,cAAsB;IAC9D,OAAO,OAAO,YAAY,CAAC,UAAU,CAAC;QACpC,OAAO;YAAE,IAAI;QAAe;IAC9B;AACF;AAKO,eAAe,yBAAyB,MAAc;IAC3D,OAAO,OAAO,YAAY,CAAC,QAAQ,CAAC;QAClC,OAAO;YAAE;QAAO;QAChB,SAAS;YAAE,WAAW;QAAO;IAC/B;AACF;AAKO,eAAe,gCAAgC,MAAc,EAAE,IAAe;IACnF,IAAI,eAAe,MAAM,OAAO,YAAY,CAAC,SAAS,CAAC;QAAE,OAAO;YAAE;QAAO;IAAE;IAC3E,IAAI,CAAC,cAAc;QACjB,eAAe,MAAM,mBAAmB,QAAQ;IAClD;IACA,OAAO;AACT","debugId":null}},
    {"offset": {"line": 632, "column": 0}, "map": {"version":3,"sources":["file:///Users/liebchen/Code/thomas/server/src/app/api/chat/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from 'next/server';\nimport { generateResponse } from '@/services/openai/generateResponse';\nimport { getOrCreateConversationByUserId } from '@/services/conversation';\nimport { createMessage } from '@/services/message';\nimport { PrismaClient } from '@prisma/client';\n\nconst HARDCODED_TOKEN = 'my_hardcoded_token'; // TODO: Replace with env var or config in future\nconst prisma = new PrismaClient();\n\nexport async function POST(req: NextRequest) {\n  try {\n    const body = await req.json();\n    const { auth_token, message } = body;\n    console.log('[POST /chat] Incoming:', { auth_token, message });\n\n    if (auth_token !== HARDCODED_TOKEN) {\n      console.warn('[POST /chat] Invalid auth token:', auth_token);\n      return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });\n    }\n\n    // Use a fixed user identifier for now\n    const userId = 'web-client';\n    // Ensure user and conversation exist\n    const user = await prisma.user.upsert({\n      where: { phoneNumber: userId },\n      update: {},\n      create: { phoneNumber: userId },\n    });\n    const conversation = await getOrCreateConversationByUserId(user.id);\n    // Store the incoming message\n    await createMessage(conversation.id, message, 'INCOMING');\n    // Generate AI response\n    const aiResponse = await generateResponse(message, { from: userId, conversationId: conversation.id });\n    // Store the AI response as a message\n    await createMessage(conversation.id, aiResponse, 'OUTGOING');\n    // Handle buffer/journal logic\n    const { handleMessageBufferAndJournal } = await import('@/services/journal');\n    await handleMessageBufferAndJournal(conversation.id);\n    console.log('[POST /chat] Reply:', aiResponse);\n    return NextResponse.json({ reply: aiResponse });\n  } catch (error) {\n    console.error('[POST /chat] Error:', error);\n    return NextResponse.json({ error: 'Invalid request' }, { status: 400 });\n  }\n} "],"names":[],"mappings":";;;AAAA;AACA;AACA;AAAA;AACA;AACA;;;;;;AAEA,MAAM,kBAAkB,sBAAsB,iDAAiD;AAC/F,MAAM,SAAS,IAAI,6HAAA,CAAA,eAAY;AAExB,eAAe,KAAK,GAAgB;IACzC,IAAI;QACF,MAAM,OAAO,MAAM,IAAI,IAAI;QAC3B,MAAM,EAAE,UAAU,EAAE,OAAO,EAAE,GAAG;QAChC,QAAQ,GAAG,CAAC,0BAA0B;YAAE;YAAY;QAAQ;QAE5D,IAAI,eAAe,iBAAiB;YAClC,QAAQ,IAAI,CAAC,oCAAoC;YACjD,OAAO,gIAAA,CAAA,eAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAAe,GAAG;gBAAE,QAAQ;YAAI;QACpE;QAEA,sCAAsC;QACtC,MAAM,SAAS;QACf,qCAAqC;QACrC,MAAM,OAAO,MAAM,OAAO,IAAI,CAAC,MAAM,CAAC;YACpC,OAAO;gBAAE,aAAa;YAAO;YAC7B,QAAQ,CAAC;YACT,QAAQ;gBAAE,aAAa;YAAO;QAChC;QACA,MAAM,eAAe,MAAM,CAAA,GAAA,iJAAA,CAAA,kCAA+B,AAAD,EAAE,KAAK,EAAE;QAClE,6BAA6B;QAC7B,MAAM,CAAA,GAAA,4HAAA,CAAA,gBAAa,AAAD,EAAE,aAAa,EAAE,EAAE,SAAS;QAC9C,uBAAuB;QACvB,MAAM,aAAa,MAAM,CAAA,GAAA,+IAAA,CAAA,mBAAgB,AAAD,EAAE,SAAS;YAAE,MAAM;YAAQ,gBAAgB,aAAa,EAAE;QAAC;QACnG,qCAAqC;QACrC,MAAM,CAAA,GAAA,4HAAA,CAAA,gBAAa,AAAD,EAAE,aAAa,EAAE,EAAE,YAAY;QACjD,8BAA8B;QAC9B,MAAM,EAAE,6BAA6B,EAAE,GAAG;QAC1C,MAAM,8BAA8B,aAAa,EAAE;QACnD,QAAQ,GAAG,CAAC,uBAAuB;QACnC,OAAO,gIAAA,CAAA,eAAY,CAAC,IAAI,CAAC;YAAE,OAAO;QAAW;IAC/C,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,uBAAuB;QACrC,OAAO,gIAAA,CAAA,eAAY,CAAC,IAAI,CAAC;YAAE,OAAO;QAAkB,GAAG;YAAE,QAAQ;QAAI;IACvE;AACF","debugId":null}}]
}